#
# Copyright 2021 Ocean Protocol Foundation
# SPDX-License-Identifier: Apache-2.0
#
from aquarius.app.pool_helper import (
    get_accumulative_values,
    build_liquidity_and_price_history,
)

dt_liquidity_changes = [
    [999.9857142857143, 190],
    [-0.360142008979846, 229],
    [-0.5855490311888735, 439],
    [0.360142008979846, 465],
    [-0.5695951910274203, 624],
    [-0.5011210805647364, 708],
    [1.0707162715921565, 888],
    [0.5855490311888735, 978],
]
ocean_liquidity_changes = [
    [116665.0, 190],
    [14522.695122782472, 200],
    [22205.606938923105, 200],
    [5321.604819324654, 200],
    [1858.2267038290895, 312],
    [29166.25, 326],
    [5000.0, 333],
    [-7596.532967881938, 404],
    [-31216.238916861716, 408],
    [-337.64201370714983, 444],
    [-462.03200364596495, 444],
    [3603.036431390275, 550],
    [-9907.888898529169, 560],
    [-214.8046389744968, 580],
    [-1038.3835407358342, 639],
    [-2747.7512181919246, 800],
    [-1081.9312369339602, 999],
    [186.03524024124576, 1200],
    [-19273.529405645306, 1329],
]


def _assert_lists_are_equal(l1, l2):
    for i, (v, t) in enumerate(l1):
        _v, _t = l2[i]
        assert t == t
        assert abs(_v - v) < 0.0000000001


def test_get_accumulative_values():
    dt_values = get_accumulative_values(dt_liquidity_changes)
    expected_values = [
        (999.9857142857143, 190),
        (999.6255722767344, 229),
        (999.0400232455455, 439),
        (999.4001652545254, 465),
        (998.8305700634979, 624),
        (998.3294489829332, 708),
        (999.4001652545253, 888),
        (999.9857142857142, 978),
    ]
    _assert_lists_are_equal(dt_values, expected_values)

    ocean_values = get_accumulative_values(ocean_liquidity_changes)
    expected_values = [
        (116665.0, 190),
        (158714.9068810302, 200),
        (160573.13358485932, 312),
        (189739.38358485932, 326),
        (194739.38358485932, 333),
        (187142.85061697738, 404),
        (155926.61170011567, 408),
        (155126.93768276257, 444),
        (158729.97411415284, 550),
        (148822.08521562367, 560),
        (148607.28057664918, 580),
        (147568.89703591334, 639),
        (144821.1458177214, 800),
        (143739.21458078746, 999),
        (143925.2498210287, 1200),
        (124651.7204153834, 1329),
    ]
    _assert_lists_are_equal(ocean_values, expected_values)


def test_build_liquidity_and_price_history():
    dt_weight = 3.0
    ocn_weight = 7.0
    swap_fee = 0.025
    _dt_values = [
        (999.9857142857143, 190),
        (999.9857142857143, 200),
        (999.6255722767344, 229),
        (999.6255722767344, 312),
        (999.6255722767344, 326),
        (999.6255722767344, 333),
        (999.6255722767344, 404),
        (999.6255722767344, 408),
        (999.0400232455455, 439),
        (999.0400232455455, 444),
        (999.4001652545254, 465),
        (999.4001652545254, 550),
        (999.4001652545254, 560),
        (999.4001652545254, 580),
        (998.8305700634979, 624),
        (998.8305700634979, 639),
        (998.3294489829332, 708),
        (998.3294489829332, 800),
        (999.4001652545253, 888),
        (999.9857142857142, 978),
        (999.9857142857142, 999),
        (999.9857142857142, 1200),
        (999.9857142857142, 1329),
    ]
    _ocn_values = [
        (116665.0, 190),
        (158714.9068810302, 200),
        (158714.9068810302, 229),
        (160573.13358485932, 312),
        (189739.38358485932, 326),
        (194739.38358485932, 333),
        (187142.85061697738, 404),
        (155926.61170011567, 408),
        (155926.61170011567, 439),
        (155126.93768276257, 444),
        (155126.93768276257, 465),
        (158729.97411415284, 550),
        (148822.08521562367, 560),
        (148607.28057664918, 580),
        (148607.28057664918, 624),
        (147568.89703591334, 639),
        (147568.89703591334, 708),
        (144821.1458177214, 800),
        (144821.1458177214, 888),
        (144821.1458177214, 978),
        (143739.21458078746, 999),
        (143925.2498210287, 1200),
        (124651.7204153834, 1329),
    ]
    _prices = [
        (51.28205128205129, 190),
        (69.76579088757542, 200),
        (69.79092589090581, 229),
        (70.60803478586708, 312),
        (83.43316654108044, 326),
        (85.63179196519451, 333),
        (82.29140586153332, 404),
        (68.56484255596713, 408),
        (68.60502921135439, 439),
        (68.25318638784982, 444),
        (68.22859079489358, 465),
        (69.81329363225088, 550),
        (65.45556371508167, 560),
        (65.36108742339205, 580),
        (65.39836037257133, 624),
        (64.9413936564153, 639),
        (64.97399161432953, 708),
        (63.764167808669335, 800),
        (63.69585349935572, 888),
        (63.658555921225876, 978),
        (63.18297495713125, 999),
        (63.264749857318286, 1200),
        (54.79274777129055, 1329),
    ]
    ocean_values, dt_values, prices = build_liquidity_and_price_history(
        ocean_liquidity_changes, dt_liquidity_changes, ocn_weight, dt_weight, swap_fee
    )
    _assert_lists_are_equal(ocean_values, _ocn_values)
    _assert_lists_are_equal(dt_values, _dt_values)
    _assert_lists_are_equal(prices, _prices)
